<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Map</title>
</head>

<body onload="onload()">
    <canvas id="canvas" width="1600" height="900"></canvas>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous"></script>
    <script src="/ctrl.js"></script>
    <script>
        let canvas, ctx;

        function onload() {
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            // ctx.fillStyle = "rgb(200,0,0)";
            // ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.font = "12px 微軟正黑體";
        }

        function same(p1, p2) {
            return p1.x == p2.x && p1.y == p2.y;
        }
        setInterval(() => {
            if (!canvas || !ctx) return;

            $.getJSON('/map', function (map) {

                // Clear
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                let role = map.role;
                let resourceList = map.resourceList;
                let monsterList = map.monsterList;
                let areaList = map.areaList;

                // for (let area of areaList) {
                //     ctx.fillStyle =
                //         `rgba(${Math.floor(Math.random()*255)},${Math.floor(Math.random()*255)},${Math.floor(Math.random()*255)})`;
                //     let points = [];
                //     for (let rect of area.includeRectList) {
                //         for (let x = rect.x; x < rect.x + rect.width; x++) {
                //             for (let y = rect.y; y < rect.y + rect.height; y++) {
                //                 points.push({
                //                     x: x,
                //                     y: y
                //                 })
                //                 console.log(x, y);
                //             }
                //         }
                //     }
                //     for (let rect of area.excludeRectList) {
                //         for (let x = rect.x; x < rect.x + rect.width; x++) {
                //             for (let y = rect.y; y < rect.y + rect.height; y++) {
                //                 let p = {
                //                     x: x,
                //                     y: y
                //                 }
                //                 points.splice(points.findIndex((p2) => same(p, p2)), 1);
                //             }
                //         }
                //     }


                //     for (let p of points) {
                //         let offsetX = p.x * canvas.width / 57;
                //         let offsetY = p.y * canvas.height / 32;
                //         ctx.fillText("口", offsetX, offsetY);
                //     }
                // }

                for (let y = 0; y <= 32; y++) {
                    for (let x = 0; x <= 57; x++) {
                        let point = {
                            x: x,
                            y: y
                        };
                        let offsetX = x * canvas.width / 57;
                        let offsetY = y * canvas.height / 32;

                        if (same(role.point, point)) {
                            ctx.fillStyle = "rgb(0,0,200)";
                            ctx.fillText("我", offsetX, offsetY);
                        } else if (monsterList.find((m) => same(m.point, point))) {
                            ctx.fillStyle = "rgb(200,0,0)";
                            ctx.fillText("怪", offsetX, offsetY);
                        } else if (resourceList.filter((r) => r.type > 100 && r.type < 200).find((r) =>
                                same(r.point, point))) {
                            ctx.fillStyle = "rgb(200,200,0)";
                            ctx.fillText("動", offsetX, offsetY);
                        } else if (resourceList.filter((r) => r.type > 200 && r.type < 300).find((r) =>
                                same(r.point, point))) {
                            ctx.fillStyle = "rgb(200,200,50)";
                            ctx.fillText("果", offsetX, offsetY);
                        } else if (resourceList.filter((r) => r.type > 300 && r.type < 400).find((r) =>
                                same(r.point, point))) {
                            ctx.fillStyle = "rgb(0,200,0)";
                            ctx.fillText("草", offsetX, offsetY);
                        } else if (resourceList.filter((r) => r.type > 400 && r.type < 500).find((r) =>
                                same(r.point, point))) {
                            ctx.fillStyle = "brown";
                            ctx.fillText("樹", offsetX, offsetY);
                        } else if (resourceList.filter((r) => r.type > 500 && r.type < 600).find((r) =>
                                same(r.point, point))) {
                            ctx.fillStyle = "rgb(0,0,0)";
                            ctx.fillText("礦", offsetX, offsetY);
                        } else if (resourceList.filter((r) => r.type > 600 && r.type < 700).find((r) =>
                                same(r.point, point))) {
                            ctx.fillStyle = "darkorange";
                            ctx.fillText("Ｏ", offsetX, offsetY);
                        } else {
                            // ctx.strokeStyle = "rgb(0,0,200)";
                            // ctx.beginPath();
                            // ctx.arc(offsetX, offsetY, 4, 0, 2 * Math.PI);
                            // ctx.stroke();
                        }

                    }
                }
            })
        }, 100)
    </script>
</body>

</html>